<!doctype html><html class="theme-next mist use-motion" lang="zh-Hans"><head><meta name="generator" content="Hexo 3.9.0"><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1"><meta http-equiv="Cache-Control" content="no-transform"><meta http-equiv="Cache-Control" content="no-siteapp"><link href="//cdn.jsdelivr.net/fancybox/2.1.5/jquery.fancybox.min.css" rel="stylesheet" type="text/css"><link href="https://fonts.lug.ustc.edu.cn/css?family=Monda:300,300italic,400,400italic,700,700italic|Roboto Slab:300,300italic,400,400italic,700,700italic|Lobster Two:300,300italic,400,400italic,700,700italic|consolas:300,300italic,400,400italic,700,700italic&subset=latin,latin-ext" rel="stylesheet" type="text/css"><link href="//maxcdn.bootstrapcdn.com/font-awesome/4.6.2/css/font-awesome.min.css" rel="stylesheet" type="text/css"><link href="/css/main.css?v=5.1.0" rel="stylesheet" type="text/css"><meta name="keywords" content="Python,coroutine,协程,"><link rel="shortcut icon" type="image/x-icon" href="/images/favicon.ico?v=5.1.0"><meta name="description" content="谈谈对协程的理解和认识"><meta name="keywords" content="Python,coroutine,协程"><meta property="og:type" content="article"><meta property="og:title" content="Python 从并发编程谈协程"><meta property="og:url" content="https://jacksonlike.cn/Python/coroutine/index.html"><meta property="og:site_name" content="Coding Runner"><meta property="og:description" content="谈谈对协程的理解和认识"><meta property="og:locale" content="zh-Hans"><meta property="og:updated_time" content="2020-06-01T09:39:40.255Z"><meta name="twitter:card" content="summary"><meta name="twitter:title" content="Python 从并发编程谈协程"><meta name="twitter:description" content="谈谈对协程的理解和认识"><script type="text/javascript" id="hexo.configurations">var NexT=window.NexT||{},CONFIG={root:"/",scheme:"Mist",sidebar:{position:"right",display:"post"},fancybox:!0,motion:!0,duoshuo:{userId:"undefined",author:"博主"},algolia:{applicationID:"",apiKey:"",indexName:"",hits:{per_page:10},labels:{input_placeholder:"Search for Posts",hits_empty:"We didn't find any results for the search: ${query}",hits_stats:"${hits} results found in ${time} ms"}}}</script><link rel="canonical" href="https://jacksonlike.cn/Python/coroutine/"><script src="//cdn.bootcss.com/pace/1.0.2/pace.min.js"></script><link href="//cdn.bootcss.com/pace/1.0.2/themes/pink/pace-theme-flash.css" rel="stylesheet"><style>.pace .pace-progress{background:#1e92fb;height:3px}.pace .pace-progress-inner{box-shadow:0 0 10px #1e92fb,0 0 5px #1e92fb}.pace .pace-activity{border-top-color:#1e92fb;border-left-color:#1e92fb}</style><title> Python 从并发编程谈协程 | Coding Runner</title></head><body itemscope itemtype="http://schema.org/WebPage" lang="zh-Hans"><script type="text/javascript">var _hmt=_hmt||[];!function(){var e=document.createElement("script");e.src="https://hm.baidu.com/hm.js?b6e35907910d61915fbb881eec0582d4";var t=document.getElementsByTagName("script")[0];t.parentNode.insertBefore(e,t)}()</script><div class="container one-collumn sidebar-position-right page-post-detail"><div class="headband"></div><header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader"><div class="header-inner"><div class="site-meta custom-logo"><div class="custom-logo-site-title"><a href="/" class="brand" rel="start"><span class="logo-line-before"><i></i></span> <span class="site-title">Coding Runner</span><span class="logo-line-after"><i></i></span></a></div><h1 class="site-subtitle" itemprop="description"></h1></div><div class="site-nav-toggle"> <button><span class="btn-bar"></span><span class="btn-bar"></span><span class="btn-bar"></span></button></div><nav class="site-nav"><ul id="menu" class="menu"><li class="menu-item menu-item-home"><a href="/" rel="section"><i class="menu-item-icon fa fa-fw fa-home"></i><br> 首页</a></li><li class="menu-item menu-item-categories"><a href="/categories" rel="section"><i class="menu-item-icon fa fa-fw fa-th"></i><br> 分类</a></li><li class="menu-item menu-item-archives"><a href="/archives" rel="section"><i class="menu-item-icon fa fa-fw fa-archive"></i><br> 归档</a></li><li class="menu-item menu-item-tags"><a href="/tags" rel="section"><i class="menu-item-icon fa fa-fw fa-tags"></i><br> 标签</a></li><li class="menu-item menu-item-search"><a href="javascript:;" class="popup-trigger"><i class="menu-item-icon fa fa-search fa-fw"></i><br> 搜索</a></li></ul><div class="site-search"><div class="popup"><span class="search-icon fa fa-search"></span> <input type="text" id="local-search-input"><div id="local-search-result"></div> <span class="popup-btn-close">close</span></div></div></nav></div></header><main id="main" class="main"><div class="main-inner"><div class="content-wrap"><div id="content" class="content"><div id="posts" class="posts-expand"><article class="post post-type-normal" itemscope itemtype="http://schema.org/Article"><link itemprop="mainEntityOfPage" href="https://jacksonlike.cn/Python/coroutine/"><span style="display:none" itemprop="author" itemscope itemtype="http://schema.org/Person"><meta itemprop="name" content="👻 杰克疯 👻"><meta itemprop="description" content><meta itemprop="image" content="/images/avatar.jpg"></span><span style="display:none" itemprop="publisher" itemscope itemtype="http://schema.org/Organization"><meta itemprop="name" content="Coding Runner"> <span style="display:none" itemprop="logo" itemscope itemtype="http://schema.org/ImageObject"><img style="display:none" itemprop="url image" alt="Coding Runner" src="/images/avatar.jpg"></span></span><header class="post-header"><h2 class="post-title" itemprop="name headline"> Python 从并发编程谈协程</h2><div class="post-meta"><span class="post-time"><span class="post-meta-item-icon"><i class="fa fa-calendar-o"></i></span> <span class="post-meta-item-text">发表于</span> <time title="Post created" itemprop="dateCreated datePublished" datetime="2019-09-15T20:43:33+00:00">2019-09-15</time></span> <span class="post-category"><span class="post-meta-divider">|</span><span class="post-meta-item-icon"><i class="fa fa-folder-o"></i></span> <span class="post-meta-item-text">分类于</span> <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/Python/" itemprop="url" rel="index"><span itemprop="name">Python</span></a></span></span><div class="post-wordcount"><span class="post-meta-item-icon"><i class="fa fa-file-word-o"></i></span> <span class="post-meta-item-text">字数统计</span> <span title="字数统计">1.9k</span> <span class="post-meta-divider">|</span><span class="post-meta-item-icon"><i class="fa fa-clock-o"></i></span> <span class="post-meta-item-text">阅读时长</span> <span title="阅读时长">7</span></div><div class="post-description"> 谈谈对协程的理解和认识</div></div></header><div class="post-body" itemprop="articleBody"><h3 id="从一个实际案例说起"><a href="#从一个实际案例说起" class="headerlink" title="从一个实际案例说起"></a>从一个实际案例说起</h3><p>当我们希望从网上爬取一些有用的信息时，就可能会写出类似以下这样的代码，不过这里简化了任务的逻辑。</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"><span class="keyword">import</span> time</span><br><span class="line"><span class="keyword">from</span> functools <span class="keyword">import</span> wraps</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">func_time</span><span class="params">(func)</span>:</span></span><br><span class="line"><span class="meta">    @wraps(func)</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">new_func</span><span class="params">(*args, **kwargs)</span>:</span></span><br><span class="line">        print(<span class="string">f'start <span class="subst">&#123;func.__name__&#125;</span>'</span>)</span><br><span class="line">        start  = time.time()</span><br><span class="line">        result = func(*args, **kwargs)</span><br><span class="line">        stop   = time.time()</span><br><span class="line">        print(<span class="string">f'finish <span class="subst">&#123;func.__name__&#125;</span>, and taking <span class="subst">&#123;format(stop - start, <span class="string">"0.2f"</span>)&#125;</span> s'</span>)</span><br><span class="line">        <span class="keyword">return</span> result</span><br><span class="line">    <span class="keyword">return</span> new_func</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">do_work</span><span class="params">(url)</span>:</span></span><br><span class="line">    requests.get(url)</span><br><span class="line"></span><br><span class="line"><span class="meta">@func_time</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">do_works_serial</span><span class="params">(tasks)</span>:</span></span><br><span class="line">    <span class="keyword">for</span> task <span class="keyword">in</span> tasks:</span><br><span class="line">        do_work(task)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">main</span><span class="params">()</span>:</span></span><br><span class="line">    tasks = [</span><br><span class="line">        <span class="string">"https://movie.douban.com/subject/5912992/"</span>,</span><br><span class="line">        <span class="string">"https://movie.douban.com/subject/30170448/"</span>,</span><br><span class="line">        <span class="string">"https://movie.douban.com/subject/30334073/"</span>,</span><br><span class="line">        <span class="string">"https://movie.douban.com/subject/1292064/"</span>,</span><br><span class="line">        <span class="string">"https://movie.douban.com/subject/21937445/"</span>,</span><br><span class="line">    ]</span><br><span class="line">    do_works_serial(tasks)</span><br><span class="line"></span><br><span class="line"><span class="comment"># output:</span></span><br><span class="line"><span class="comment"># start do_works_serial</span></span><br><span class="line"><span class="comment"># finish do_works_serial, and taking 3.59 s</span></span><br></pre></td></tr></table></figure><p>上面的代码处理方式是依次进行网络请求，上一个请求返回之后再进行下一个请求。</p><p>这种方式在需要处理的小任务不多的时候，倒也是可行的。但是处理方式非常笨拙，会有大量的时间耗费在等待请求的返回，没有充分地利用到计算机的资源，所以通常对于这样的需求，最容易想到的就是多线程和多进程，就像下面的代码一样。</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@func_time</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">do_works_muti_threads</span><span class="params">(tasks)</span>:</span></span><br><span class="line">    threads = set()</span><br><span class="line">    <span class="keyword">for</span> task <span class="keyword">in</span> tasks:</span><br><span class="line">        t = threading.Thread(target=do_work, args=(task,))</span><br><span class="line">        t.start()</span><br><span class="line">        threads.add(t)</span><br><span class="line">    <span class="comment"># 等待所有线程的结束</span></span><br><span class="line">    <span class="keyword">for</span> t <span class="keyword">in</span> threads:</span><br><span class="line">        t.join()</span><br><span class="line"></span><br><span class="line"><span class="meta">@func_time</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">do_works_muti_processes</span><span class="params">(tasks)</span>:</span></span><br><span class="line">    processes = set()</span><br><span class="line">    <span class="keyword">for</span> task <span class="keyword">in</span> tasks:</span><br><span class="line">        t = Process(target=do_work, args=(task,))</span><br><span class="line">        t.start()</span><br><span class="line">        processes.add(t)</span><br><span class="line">    <span class="comment"># 等待所有进程的结束</span></span><br><span class="line">    <span class="keyword">for</span> t <span class="keyword">in</span> processes:</span><br><span class="line">        t.join()</span><br><span class="line"></span><br><span class="line"><span class="comment"># output</span></span><br><span class="line"><span class="comment"># start do_works_muti_threads</span></span><br><span class="line"><span class="comment"># finish do_works_muti_threads, and taking 1.38 s</span></span><br><span class="line"><span class="comment"># start do_works_muti_processes</span></span><br><span class="line"><span class="comment"># finish do_works_muti_processes, and taking 1.61 s</span></span><br></pre></td></tr></table></figure><p>可以发现，不论是多线程或者多进程的方案，都会提升程序的效率（当然这里的计时并不严谨，因为网络波动会影响耗时），实际上多线程或者多进程的也是软件工程解决并发问题常用的手段。</p><p>不过多线程或者多进程的方案并不是万能的，这两种方案存在一些问题，第一，会占用额外的系统资源，而且进程会占用更多的资源，互联网领域有名的 C10K 问题，就印证了这点，频繁的上下文切换带来了大量的资源消耗。第二，多线程会有同步共享资源的问题，使用锁无疑又会增加资源的消耗，而多进程的方案会有进程间通信问题。</p><p>随着技术的进步，人们又推出了协程的概念，可以轻松应对上述问题。而 Python 也在语言层面提供了支持，使得协程即提高了程序运行效率，又保证了代码的可读性，本文的示例代码都是基于 Python 3.7的（另一种基于生成器的协程，使用 <code>@asyncio.coroutine</code> 装饰，不过会在 Python 3.10 中移除，这里不做讨论了）。</p><h3 id="使用协程解决并发问题"><a href="#使用协程解决并发问题" class="headerlink" title="使用协程解决并发问题"></a>使用协程解决并发问题</h3><p>说了那么多，Python 3.7 中使用协程是如何解决上面提到案例呢？</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> asyncio</span><br><span class="line"><span class="keyword">import</span> aiohttp</span><br><span class="line"><span class="keyword">import</span> threading</span><br><span class="line"></span><br><span class="line"><span class="keyword">async</span> <span class="function"><span class="keyword">def</span> <span class="title">do_work_async</span><span class="params">(url)</span>:</span></span><br><span class="line">    print(<span class="string">f'<span class="subst">&#123;url&#125;</span>:<span class="subst">&#123;threading.currentThread().ident&#125;</span>'</span>)</span><br><span class="line">    <span class="keyword">async</span> <span class="keyword">with</span> aiohttp.ClientSession() <span class="keyword">as</span> session:</span><br><span class="line">        <span class="keyword">async</span> <span class="keyword">with</span> session.get(url) <span class="keyword">as</span> _:</span><br><span class="line">            print(<span class="string">f'<span class="subst">&#123;url&#125;</span> done'</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">async</span> <span class="function"><span class="keyword">def</span> <span class="title">coro_func</span><span class="params">(tasks)</span>:</span></span><br><span class="line">    tasks = (asyncio.create_task(do_work_async(task)) <span class="keyword">for</span> task <span class="keyword">in</span> tasks)</span><br><span class="line">    print(<span class="string">'before tasks'</span>)</span><br><span class="line">    <span class="keyword">await</span> asyncio.gather(*tasks)</span><br><span class="line">    print(<span class="string">'finish tasks'</span>)</span><br><span class="line"></span><br><span class="line"><span class="meta">@func_time</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">do_works_coroutine</span><span class="params">(tasks)</span>:</span></span><br><span class="line">    asyncio.run(coro_func(tasks))</span><br><span class="line"></span><br><span class="line"><span class="comment"># output</span></span><br><span class="line"><span class="comment"># start do_works_coroutine</span></span><br><span class="line"><span class="comment"># before tasks</span></span><br><span class="line"><span class="comment"># https://movie.douban.com/subject/5912992/:3856</span></span><br><span class="line"><span class="comment"># https://movie.douban.com/subject/30170448/:3856</span></span><br><span class="line"><span class="comment"># https://movie.douban.com/subject/30334073/:3856</span></span><br><span class="line"><span class="comment"># https://movie.douban.com/subject/1292064/:3856</span></span><br><span class="line"><span class="comment"># https://movie.douban.com/subject/21937445/:3856</span></span><br><span class="line"><span class="comment"># https://movie.douban.com/subject/1292064/ done</span></span><br><span class="line"><span class="comment"># https://movie.douban.com/subject/21937445/ done</span></span><br><span class="line"><span class="comment"># https://movie.douban.com/subject/5912992/ done</span></span><br><span class="line"><span class="comment"># https://movie.douban.com/subject/30334073/ done</span></span><br><span class="line"><span class="comment"># https://movie.douban.com/subject/30170448/ done</span></span><br><span class="line"><span class="comment"># finish tasks</span></span><br><span class="line"><span class="comment"># finish do_works_coroutine, and taking 1.02 s</span></span><br></pre></td></tr></table></figure><p>可以发现代码只有短短的10来行，不过对于没有接触过协程的同学来说，不太好理解，所以针对上面代码，这里稍作梳理，更多关于 <code>async</code> 的介绍和用法应该参考<a href="https://docs.python.org/3/library/asyncio.html" target="_blank" rel="noopener">官方文档</a>。</p><h4 id="概念梳理"><a href="#概念梳理" class="headerlink" title="概念梳理"></a>概念梳理</h4><ul><li>协程函数: 定义形式为 <code>async def</code> 的函数</li><li>协程对象: 调用 <em>协程函数</em> 所返回的对象</li><li>await: 等待协程的返回</li><li>协程函数直接调用并不会被执行，而是返回协程对象，另外还会得到一个警告 <code>coroutine &#39;xxx&#39; was never awaited</code> ，所以说协程函数与 <code>await</code> 通常是配套使用的。</li><li>asyncio.run： 该函数接收的参数是协程，负责管理整个事件循环，调用时会创建一个新的事件循环并在结束时关闭之，它应当被用作 asyncio 程序的主入口点，理想情况下应当只被调用一次。</li><li>asyncio.create_task： 将协程打包并返回一个 <code>Task</code> 对象，而Task 对象被用来在事件循环中运行协程，可以通过 <code>Task</code> 对象取消正在运行的任务，或者是获取任务是否已经完成等信息。</li><li>asyncio.gather： 并发的运行 <code>Task</code> 对象</li></ul><h4 id="运行逻辑探讨"><a href="#运行逻辑探讨" class="headerlink" title="运行逻辑探讨"></a>运行逻辑探讨</h4><p>了解完上面这些内容之后，我们再回过头来分析下代码。</p><ol><li>asyncio.run(coro_func(tasks)) 开始进入事件循环。</li><li>task 依次被创建，进入事件循环并开始等待运行；打印 “before tasks”。</li><li>await asyncio.gather，开始‘并发’的执行 task，通过打印的 log 发现虽说是‘并发’，但实际上依然是单线程运行。程序运行到 <code>aiohttp.ClientSession()</code> 或者 <code>session.get(url)</code> 时并不会阻塞，而是切出当前任务，由事件调度器开始调度下一个任务。</li><li>当所有的任务都进入了等待状态之后，事件调度器也会暂停，直到有任务返回。</li><li>有任务请求返回则会获取到调度器的控制权，打印对应的 “url done”。</li><li>所有协程执行完成后，<code>asyncio.run</code> 返回，事件循环结束。</li></ol><h3 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h3><h4 id="协程到底是什么"><a href="#协程到底是什么" class="headerlink" title="协程到底是什么"></a>协程到底是什么</h4><p>以上说了这么多之后，应该了解了什么是协程，协程的工作机理，但是如果要一句话描述出来，还真不太好说。所以在 <code>Stack Overflow</code> 看到一句话<a href="https://stackoverflow.com/questions/553704/what-is-a-coroutine?tdsourcetag=s_pcqq_aiomsg" target="_blank" rel="noopener">描述</a>，感觉挺合适的，就迁移过来了。</p><p><strong>协程是一种通用控制结构，其中流的控制权在不同任务之间协同传递而不返回。</strong></p><h4 id="并发编程中，协程的优劣"><a href="#并发编程中，协程的优劣" class="headerlink" title="并发编程中，协程的优劣"></a>并发编程中，协程的优劣</h4><p>线程会比协程更重一些，需要操作系统知道线程的信息，操作系统会在合适的时机进行线程切换，这样做的优势就是代码简单，程序员友好，无需关系任务切换逻辑。</p><p>相比进程和线程，协程应该是最轻量的一种并发方案，任务切换完全由程序员自由控制，只有当上一个任务交出控制权下一个任务才能开始执行。对比线程，协程会更高效，但同时也存在一个问题，需要库提供者的支持，比如上面的例程中用到的 <code>aiohttp</code> ，如果开源社区没有的话，那么就需要自行实现了。</p><p>而多进程则是一种真正的并行方案，在多核 CPU 的机器上能同时运行多个进程。</p><p>总的来说，协程和线程更适合处理 I/O 密集的场景，特别是 Python 中的多线程实际上也只是单线程中执行；而对于 CPU 密集的场景来说，多进程、多机器、多处理器才能提高程序的运行速度。</p><h3 id="代码地址"><a href="#代码地址" class="headerlink" title="代码地址"></a>代码地址</h3><p> <a href="https://github.com/Jacksonlike/blog_code/tree/master/coroutine" target="_blank" rel="noopener">https://github.com/Jacksonlike/blog_code/tree/master/coroutine</a></p><h3 id="参考文档"><a href="#参考文档" class="headerlink" title="参考文档"></a>参考文档</h3><p><a href="https://stackoverflow.com/questions/553704/what-is-a-coroutine?tdsourcetag=s_pcqq_aiomsg" target="_blank" rel="noopener">Stack Overflow</a><br><a href="https://docs.python.org/3/library/asyncio.html" target="_blank" rel="noopener">asyncio 官方文档</a><br><a href="https://www.geeksforgeeks.org/coroutine-in-python/?tdsourcetag=s_pcqq_aiomsg" target="_blank" rel="noopener">Coroutine in Python</a><br><a href="https://python-parallel-programmning-cookbook.readthedocs.io/zh_CN/latest/chapter4/index.html" target="_blank" rel="noopener">python-parallel-programmning-cookbook</a></p></div><div></div><div class="post-tags"> <a href="/tags/Python/" rel="tag"># Python</a> <a href="/tags/coroutine/" rel="tag"># coroutine</a> <a href="/tags/协程/" rel="tag"># 协程</a></div><div></div><footer class="post-footer"><div><ul class="post-copyright"><li class="post-copyright-link"> <strong>本文作者：</strong> <a href="/" title="欢迎访问 👻 杰克疯 👻 的个人博客">👻 杰克疯 👻</a></li><li class="post-copyright-link"> <strong>本文链接：</strong> <a href="https://jacksonlike.cn/Python/coroutine/" title="Python 从并发编程谈协程">https://jacksonlike.cn/Python/coroutine/</a></li><li class="post-copyright-license"> <strong>版权声明：</strong> 本文由 👻 杰克疯 👻 原创，采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/deed.en" rel="license" target="_blank">CC BY-NC-SA 4.0，</a> 转载请保留以上声明信息！</li></ul></div><div class="post-nav"><div class="post-nav-next post-nav-item"><a href="/Python/metaclass/" rel="next" title="Python 元类(Metaclass)"><i class="fa fa-chevron-left"></i> Python 元类(Metaclass)</a></div><span class="post-nav-divider"></span><div class="post-nav-prev post-nav-item"> <a href="/Web/web-security/" rel="prev" title="Web 安全攻防总结">Web 安全攻防总结<i class="fa fa-chevron-right"></i></a></div></div></footer></article><div class="post-spread"></div></div></div><div class="comments" id="comments"><div id="lv-container" data-id="city" data-uid="MTAyMC80NDE5Ny8yMDczMA=="></div></div></div><div class="sidebar-toggle"><div class="sidebar-toggle-line-wrap"><span class="sidebar-toggle-line sidebar-toggle-line-first"></span><span class="sidebar-toggle-line sidebar-toggle-line-middle"></span><span class="sidebar-toggle-line sidebar-toggle-line-last"></span></div></div><aside id="sidebar" class="sidebar"><div class="sidebar-inner"><ul class="sidebar-nav motion-element"><li class="sidebar-nav-toc sidebar-nav-active" data-target="post-toc-wrap"> 文章目录</li><li class="sidebar-nav-overview" data-target="site-overview"> 站点概览</li></ul><section class="site-overview sidebar-panel"><div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person"> <img class="site-author-image" itemprop="image" src="/images/avatar.jpg" alt="👻 杰克疯 👻"><p class="site-author-name" itemprop="name">👻 杰克疯 👻</p><p class="site-description motion-element" itemprop="description">一直在学着写代码的程序员 🥤🥤🥤</p></div><nav class="site-state motion-element"><div class="site-state-item site-state-posts"> <a href="/archives"><span class="site-state-item-count">6</span> <span class="site-state-item-name">日志</span></a></div><div class="site-state-item site-state-categories"> <a href="/categories"><span class="site-state-item-count">6</span> <span class="site-state-item-name">分类</span></a></div><div class="site-state-item site-state-tags"> <a href="/tags"><span class="site-state-item-count">16</span> <span class="site-state-item-name">标签</span></a></div></nav><div class="links-of-author motion-element"><span class="links-of-author-item"><a href="https://github.com/Jacksonlike" target="_blank" title="GitHub"><i class="fa fa-fw fa-github-alt"></i> GitHub</a></span><span class="links-of-author-item"><a href="https://note.jacksonlike.cn/" target="_blank" title="Note"><i class="fa fa-fw fa-leanpub"></i> Note</a></span></div></section><section class="post-toc-wrap motion-element sidebar-panel sidebar-panel-active"><div class="post-toc"><div class="post-toc-content"><ol class="nav"><li class="nav-item nav-level-3"><a class="nav-link" href="#从一个实际案例说起"><span class="nav-number">1.</span> <span class="nav-text">从一个实际案例说起</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#使用协程解决并发问题"><span class="nav-number">2.</span> <span class="nav-text">使用协程解决并发问题</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#概念梳理"><span class="nav-number">2.1.</span> <span class="nav-text">概念梳理</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#运行逻辑探讨"><span class="nav-number">2.2.</span> <span class="nav-text">运行逻辑探讨</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#总结"><span class="nav-number">3.</span> <span class="nav-text">总结</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#协程到底是什么"><span class="nav-number">3.1.</span> <span class="nav-text">协程到底是什么</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#并发编程中，协程的优劣"><span class="nav-number">3.2.</span> <span class="nav-text">并发编程中，协程的优劣</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#代码地址"><span class="nav-number">4.</span> <span class="nav-text">代码地址</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#参考文档"><span class="nav-number">5.</span> <span class="nav-text">参考文档</span></a></li></ol></div></div></section></div></aside></div></main><footer id="footer" class="footer"><div class="footer-inner"><div class="copyright"> &copy; <span itemprop="copyrightYear">2020</span><span class="with-love"><i class="fa fa-heart"></i></span> <span class="author" itemprop="copyrightHolder">👻 杰克疯 👻</span></div><div class="powered-by"> 由 <a class="theme-link" href="https://hexo.io" rel="external nofollow">Hexo</a> 强力驱动</div><div class="theme-info"> 主题 - <a class="theme-link" href="https://github.com/iissnan/hexo-theme-next" rel="external nofollow">NexT.Mist</a></div></div></footer><div class="back-to-top"><i class="fa fa-arrow-up"></i></div></div><script type="text/javascript">"[object Function]"!==Object.prototype.toString.call(window.Promise)&&(window.Promise=null)</script><script type="text/javascript" src="//cdn.jsdelivr.net/jquery/2.1.3/jquery.min.js"></script><script type="text/javascript" src="//cdn.jsdelivr.net/fastclick/1.0.6/fastclick.min.js"></script><script type="text/javascript" src="//cdn.jsdelivr.net/jquery.lazyload/1.9.3/jquery.lazyload.min.js"></script><script type="text/javascript" src="//cdn.jsdelivr.net/velocity/1.2.3/velocity.min.js"></script><script type="text/javascript" src="//cdn.jsdelivr.net/velocity/1.2.3/velocity.ui.min.js"></script><script type="text/javascript" src="//cdn.jsdelivr.net/fancybox/2.1.5/jquery.fancybox.pack.js"></script><script type="text/javascript" src="/js/src/utils.js?v=5.1.0"></script><script type="text/javascript" src="/js/src/motion.js?v=5.1.0"></script><script type="text/javascript" src="/js/src/scrollspy.js?v=5.1.0"></script><script type="text/javascript" src="/js/src/post-details.js?v=5.1.0"></script><script type="text/javascript" src="/js/src/bootstrap.js?v=5.1.0"></script><script type="text/javascript">!function(e,t){var n,c=e.getElementsByTagName(t)[0];"function"!=typeof LivereTower&&((n=e.createElement(t)).src="https://cdn-city.livere.com/js/embed.dist.js",n.async=!0,c.parentNode.insertBefore(n,c))}(document,"script")</script><script type="text/javascript">var isfetched=!1,search_path="search.xml";0==search_path.length&&(search_path="search.xml");var path="/"+search_path;function proceedsearch(){$("body").append('<div class="popoverlay">').css("overflow","hidden"),$(".popup").toggle()}var searchFunc=function(e,c,n){"use strict";$.ajax({url:e,dataType:"xml",async:!0,success:function(e){isfetched=!0,$(".popup").detach().appendTo(".header-inner");var t=$("entry",e).map(function(){return{title:$("title",this).text(),content:$("content",this).text(),url:$("url",this).text()}}).get(),a=document.getElementById(c),r=document.getElementById(n);a.addEventListener("input",function(){var u=0,d='<ul class="search-result-list">',f=this.value.trim().toLowerCase().split(/[\s\-]+/);r.innerHTML="",1<this.value.trim().length&&t.forEach(function(e){var a=!1,r=e.title.trim().toLowerCase(),c=e.content.trim().replace(/<[^>]+>/g,"").toLowerCase(),t=decodeURIComponent(e.url),n=-1,s=-1,o=-1;if(""!=r&&f.forEach(function(e,t){n=r.indexOf(e),s=c.indexOf(e),(0<=n||0<=s)&&(a=!0,0==t&&(o=s))}),a){u+=1,d+="<li><a href='"+t+"' class='search-result-title'>"+r+"</a>";var i=e.content.trim().replace(/<[^>]+>/g,"");if(0<=o){var l=o-20,p=o+80;l<0&&(l=0),0==l&&(p=50),p>i.length&&(p=i.length);var h=i.substring(l,p);f.forEach(function(e){var t=new RegExp(e,"gi");h=h.replace(t,'<b class="search-keyword">'+e+"</b>")}),d+='<p class="search-result">'+h+"...</p>"}d+="</li>"}}),d+="</ul>",0==u&&(d='<div id="no-result"><i class="fa fa-frown-o fa-5x" /></div>'),""==f&&(d='<div id="no-result"><i class="fa fa-search fa-5x" /></div>'),r.innerHTML=d}),proceedsearch()}})};$(".popup-trigger").click(function(e){e.stopPropagation(),0==isfetched?searchFunc(path,"local-search-input","local-search-result"):proceedsearch()}),$(".popup-btn-close").click(function(e){$(".popup").hide(),$(".popoverlay").remove(),$("body").css("overflow","")}),$(".popup").click(function(e){e.stopPropagation()})</script><script>!function(){var t=document.createElement("script"),e=window.location.protocol.split(":")[0];t.src="https"===e?"https://zz.bdstatic.com/linksubmit/push.js":"http://push.zhanzhang.baidu.com/push.js";var s=document.getElementsByTagName("script")[0];s.parentNode.insertBefore(t,s)}()</script><script type="text/javascript" src="/js/src/love.js"></script></body></html>